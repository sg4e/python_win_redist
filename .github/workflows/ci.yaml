name: ci

on: push

jobs:
  build_release:
    name: build and release
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Download Python 3.6
        run: |
          curl -o python-3.6.8.exe https://www.python.org/ftp/python/3.6.8/python-3.6.8.exe

      - name: Install Python 3.6
        shell: cmd
        run: |
          python-3.6.8.exe /quiet PrependPath=1 Include_test=0
          whoami
          dir
          
      - name: Prepare Python 3.6 venv
        shell: cmd
        run: |
          mkdir C:\venv
          %LocalAppData%\Programs\Python\Python36\python.exe" -m venv c:\venv
          dir C:\venv
          
      - name: Install pip dependency
        shell: cmd
        working-directory: C:\venv
        run: |
          .\Scripts\activate
          python -m pip install Sphinx==3.5.4
          
      - name: Download Python 3.9 source
        run: |
          curl -o C:\python.tar.xz https://www.python.org/ftp/python/3.9.14/Python-3.9.14.tar.xz


      - name: Extract Python 3.9 source
        run: |
          echo "::add-path::C:\Program Files\Git\mingw64\bin"
          echo "::add-path::C:\Program Files\Git\usr\bin"
          echo "::add-path::C:\Program Files\Git\bin"
          tar -xvzf C:\python.tar.xz -C C:\venv
          dir C:\venv

      - name: Build python 3.9 from source
        shell: cmd
        working-directory: C:\venv
        run: |
          buildrelease.bat -x86 -x64 --skip-pgo
          dir
          
      - name: Generate release tag
        id: tag
        run: |
          echo "::set-output name=release_tag::UserBuild_$(date +"%Y.%m.%d_%H-%M")"
          
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          fail_on_unmatched_files: true
          tag_name: ${{ steps.tag.outputs.release_tag }}
          files: |
            C:/venv/PCbuild/win32/*
